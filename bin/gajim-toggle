#!/bin/sh

name=org.gajim.dbus
object_path=/org/gajim/dbus/RemoteObject
interface=org.gajim.dbus.RemoteInterface

check_gajim_running() {
    dbus-send --dest=org.freedesktop.DBus --print-reply=literal \
        /org/freedesktop/DBus org.freedesktop.DBus.NameHasOwner \
        string:"$name" |
    grep -Fq true
}

get_unread_msgs_number() {
    dbus-send --dest="$name" --print-reply=literal \
        "$object_path" "$interface".get_unread_msgs_number |
    sed 's/ *//'
}

show_next_pending_event() {
    dbus-send --dest="$name" --type=method_call \
        "$object_path" "$interface".show_next_pending_event
}

toggle_roster_appearance() {
    dbus-send --dest="$name" --type=method_call \
        "$object_path" "$interface".toggle_roster_appearance
}

check_gajim_running || exec gajim "$@"

case "$(get_unread_msgs_number)" in
0) toggle_roster_appearance ;;
*) show_next_pending_event
esac
